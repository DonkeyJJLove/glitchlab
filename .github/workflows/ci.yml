name: GLX CI

on:
  pull_request:
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  pull-requests: write
  issues: write                # potrzebne do tworzenia komentarzy na PR (issues.createComment)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-test-analyze:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install system / fix setuptools deprecation + dev extras
        # Pinujemy setuptools<81 by uniknąć UserWarning/rozbicia w przyszłości
        run: |
          python -m pip install -U pip
          python -m pip install "setuptools<81"
          # Wymaga zdefiniowanych extras w pyproject.toml: [project.optional-dependencies].dev
          pip install -e .[dev]

      - name: Determine DIFF range
        id: range
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            RANGE="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          else
            RANGE="HEAD~1..HEAD"
          fi
          # Zapis do GITHUB_ENV aby był dostępny w kolejnych krokach
          echo "DIFF_RANGE=${RANGE}" >> $GITHUB_ENV
          # Echo lokalnie aby widzieć w logu (w poprzedniej wersji echo $DIFF_RANGE było puste)
          echo "Using range: ${RANGE}"

      - name: Run pre-commit (formatters / quick checks)
        uses: pre-commit/action@v4
        with:
          extra_args: --all-files

      - name: Ruff (lint)
        run: ruff . --force-exclude

      - name: Black (format check)
        run: python -m black --check .

      - name: Mypy (type check)
        run: mypy glitchlab

      - name: Pytest
        run: pytest -q

      - name: Coverage (run + upload as artifact)
        if: always()
        run: |
          pip install coverage
          coverage run -m pytest
          coverage xml -i
        # upload coverage report
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage.xml
          if-no-files-found: ignore

      - name: Doclint (docs consistency)
        run: python -m glx.tools.doclint

      - name: Delta fingerprint (DIFF-first)
        run: python -m glx.tools.delta_fingerprint --range "${{ env.DIFF_RANGE }}"

      - name: Invariants check (I1–I4 gates)
        run: python -m glx.tools.invariants_check --range "${{ env.DIFF_RANGE }}"

      - name: Upload GLX artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: glx-artifacts-${{ matrix.python-version }}
          path: |
            glitchlab/.glx/delta_report.json
            glitchlab/.glx/commit_analysis.json
            glitchlab/.glx/spec_state.json
            glitchlab/.glx/*.png
          if-no-files-found: ignore

      - name: Comment on PR (summary)
        if: github.event_name == 'pull_request' && matrix.python-version == '3.9'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            function readJson(p) {
              try { return JSON.parse(fs.readFileSync(p, 'utf8')); } catch (e) { return null; }
            }
            const delta = readJson('glitchlab/.glx/delta_report.json') || {};
            const analysis = readJson('glitchlab/.glx/commit_analysis.json') || {};
            const lines = [];
            lines.push('### GLX Δ Summary');
            if (delta.hist) {
              const keys = Object.keys(delta.hist);
              const top = keys.sort((a,b) => (delta.hist[b]||0)-(delta.hist[a]||0)).slice(0,8).map(k => `\`${k}\`×${delta.hist[k]}`);
              lines.push(`**Δ-tokens:** ${top.join(', ')}`);
            } else {
              lines.push('_Brak delta_report.json_');
            }
            if (delta.hash) lines.push(`**Fingerprint:** \`${delta.hash}\``);
            if (analysis.score !== undefined) lines.push(`**Score:** ${analysis.score}  | thresholds α=${analysis.thresholds?.alpha} β=${analysis.thresholds?.beta} Z=${analysis.thresholds?.z}`);
            if (analysis.violations && analysis.violations.length) {
              lines.push(`**Violations:** ${analysis.violations.map(v => `\`${v.invariant}\`(${v.severity})`).join(', ')}`);
            }
            const body = lines.join('\n');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

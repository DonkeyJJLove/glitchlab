# I. Audyt paczek i decyzje

## 1) `glx_catalog_v5.zip` (katalog referencyjny)

**ZawartoÅ›Ä‡ kluczowa (wyciÄ…g):**

* `docs/bus.md`, `docs/egdb.md`, `docs/ci_ops.md`, `docs/gui.md`, `docs/observability.md`, `docs/pipelines.md`,
* `docs/GLX_Mosaika_Matematyka_v5.md`, `docs/12_mosaic_metrics.md`,
* `schemas/*.json` (m.in. `git.delta.ready.schema.json`, `publish.schema.json`, `fail.closed.schema.json`).

**Decyzja:**

* âœ… **WÅ‚Ä…czyÄ‡ jako ÅºrÃ³dÅ‚a kanoniczne/zaÅ‚Ä…czniki**:
  *`GLX_Mosaika_Matematyka_v5.md`*, *`12_mosaic_metrics.md`* â†’ do **appendix** sekcji *Mosaic/Mathematics*.
  *`schemas/*.json`* â†’ do `/spec/schemas` (SSOT).
* ğŸ§© **ScaliÄ‡ z obecnymi**: *`bus.md`, `egdb.md`, `observability.md`, `ci_ops.md`, `gui.md`, `pipelines.md`* â€” masz juÅ¼ Å›wieÅ¼e wersje w `docs/20_bus.md`, `docs/21_egdb.md`, `docs/70_observability.md`, `docs/50_ci_ops.md`, `docs/40_gui_app.md`, `docs/41_pipelines.md`. TreÅ›ci z katalogu potraktujmy jako **materiaÅ‚ porÃ³wnawczy**: fragmenty, ktÃ³re rozszerzajÄ… definicje lub majÄ… ryciny, wÅ‚Ä…czymy jako przypisy/ramki w bieÅ¼Ä…cych dokumentach.
* âš™ï¸ **Do archiwum**: starsze wersje opisÃ³w repo/release (*`repo.md`*) â€” zachowaÄ‡ w `/glx_catalog_v5/backup/` dla historii.

## 2) `core_docs.zip` (nowsze wersje Twoich nowych plikÃ³w `docs/..`)

**ZawartoÅ›Ä‡:**

* `docs/10_architecture.md`, `docs/11_spec_glossary.md`, `docs/12_invariants.md`, `docs/13_delta_algebra.md`, `docs/20_bus.md`, `docs/21_egdb.md`, `docs/41_pipelines.md`.

**Decyzja:**

* âœ… **ZostajÄ…**: nasze Å›wieÅ¼o wygenerowane pliki sÄ… spÃ³jne z ukÅ‚adem repo i juÅ¼ odwoÅ‚ujÄ… siÄ™ do BUS/EGDB/Mozaiki/CI. Ten ZIP traktujemy jako **snapshot kontrolny** (w razie rollbacku).
* ğŸ§© **Drobne uzupeÅ‚nienia**: do `docs/41_pipelines.md` dodamy odnoÅ›niki do `core/registry.py` i `core/steps/*` (z Twojej struktury repo), oraz do `gui/services/pipeline_runner.py` (Å›cieÅ¼ka wywoÅ‚ania).

## 3) `analysis.zip`

**ZawartoÅ›Ä‡ (skrÃ³t):**

* `analysis/*.py` (metrics, diff, spectral, formats, exporters, ast_*),
* `analysis/analiza_progi.md`,
* artefakty `analysis/last/*` (pack/summary) i dzienniki commitÃ³w.

**Decyzja:**

* âœ… **WÅ‚Ä…czyÄ‡ do dokumentacji**: *`analysis/analiza_progi.md`* â€” to bezpoÅ›rednio zasila rozdziaÅ‚ o kalibracji progÃ³w (link do `docs/12_invariants.md` i nowego `docs/31_analytics.md`).
* ğŸ§© **WkomponowaÄ‡ jako â€œExamplesâ€**: *`analysis/last/summary.md`*, *`analysis/last/autonomy/pack.md`* â€” dodamy jako **Appendix: Example Artifacts** w `docs/31_analytics.md`.
* âš™ï¸ **Do archiwum**: logi `analysis/logs/*.json` (warto zachowaÄ‡ w repo pod `.glx/`/`backup/`, ale nie jako dokumentacja).

## 4) Pliki luzem w /mnt/data

* `GlitchLab_Arch_v5.md` â€” âœ… **Appendix** do `docs/10_architecture.md` (diagramy/terminologia spaÅ›Ä‡ do przypisÃ³w).
* `GLXENCJE â€” MANIFEST v3.6 (FINAL).MD` â€” ğŸ§© **WyciÄ…g definicji** (nomenklatura GLXENCJE) do `docs/11_spec_glossary.md` (sekcja SÅ‚ownik â†’ blok *GLXENCJE* jako *namespace*).
* `DIFF_SUMMARY.md` â€” ğŸ§© **ZacytowaÄ‡ w** `docs/13_delta_algebra.md` (czÄ™Å›Ä‡ *Fingerprint & Histogram*).
* `README.MD` â€” âœ… pozostaje w repo; **sekcjÄ™ Quickstart** zsynchronizujemy po scaleniu TOC.

---

# II. PorzÄ…dek numeracji i ToC (z renamami)

Aby **wstawiÄ‡ nowÄ… gaÅ‚Ä…Åº â€œAnalyticsâ€** bez ruszania istniejÄ…cych identyfikatorÃ³w, proponujÄ™:

* **NOWY:** `docs/31_analytics.md` (miÄ™dzy 30 a 40).
* **Renamy kosmetyczne** (dla przejrzystoÅ›ci, *zachowujemy stare pliki z krÃ³tkim bannerem â€œprzeniesiono do â€¦â€*):

  * `docs/80_release.md` â†’ `docs/82_release_and_channels.md`
  * `docs/90_playbooks.md` â†’ `docs/92_playbooks.md`

> DziÄ™ki temu **nie psujemy** istniejÄ…cych linkÃ³w (stare pliki zostajÄ… jako â€œstubâ€ z przekierowaniem), a ToC ukÅ‚ada siÄ™ czytelnie:

```
00_overview.md
10_architecture.md
11_spec_glossary.md
12_invariants.md
13_delta_algebra.md
14_mosaic.md
20_bus.md
21_egdb.md
30_sast_bridge.md
31_analytics.md   <-- NOWE
40_gui_app.md
41_pipelines.md
50_ci_ops.md
60_security.md
70_observability.md
82_release_and_channels.md   <-- rename z 80
92_playbooks.md              <-- rename z 90
```

---

# III. (NOWE) `docs/31_analytics.md` â€” **peÅ‚na treÅ›Ä‡**

> **Cel:** scaliÄ‡ *warstwÄ™ analitycznÄ…* (analysis/), *kalibracjÄ™ progÃ³w* oraz *powiÄ…zanie z AgentemAI* w jednÄ…, operacyjnÄ… specyfikacjÄ™. Dokument jest SSOT dla dynamiki metryk Î”, EWMA/MAD, t-digest, drift i HUD.

```markdown
# GlitchLab â€” Analytics Layer (Î”-Metrics, Calibration, Drift, AgentAI)

**Id:** docs/31_analytics.md  
**Zakres:** strumieÅ„ metryk Î”, kalibracja progÃ³w (Î±/Î²/Z), detekcja driftu, integracja z AgentemAI, artefakty `.glx/*`, zapytania EGDB/EGQL, HUD (Spec Monitor).

---

## 1. Rola warstwy Analytics

Warstwa Analytics tworzy **Å¼ywy model zachowania repo** na osi czasu:
- destyluje **cechy Î”** (kod/obrazy/AST) z bieÅ¼Ä…cych commitÃ³w/PR,
- utrzymuje **kalibrowane progi** Î±/Î²/Z (per moduÅ‚/warstwa),
- wykrywa **drift** i zarzÄ…dza stanem â€freeze/unfreezeâ€ progÃ³w,
- zasila **HUD** (panele: *Spec Monitor*, *Delta Inspector*) oraz **AgentemAI** (RAG + reguÅ‚y *self-healing*).

> **SSOT:** definicje metryk + reguÅ‚ Å¼yjÄ… w `/spec/invariants.yaml` oraz `/spec/schemas/*.json`  
> **Å¹rÃ³dÅ‚a danych:** moduÅ‚y `analysis/*`, wyniki CI/HookÃ³w, EGDB (event log).

---

## 2. StrumieÅ„ metryk Î” (features)

### 2.1 Å¹rÃ³dÅ‚a

- `analysis/metrics.py` â€” entropia, gÄ™stoÅ›Ä‡ krawÄ™dzi, RMS, itp. *(wejÅ›cia obrazu)*  
- `analysis/diff.py` â€” SSIM/PSNR/delta-heatmapy *(zmiany obrazÃ³w)*  
- `analysis/spectral.py` â€” FFT + pasma *(czÄ™stotliwoÅ›ci)*  
- `analysis/formats.py` â€” heurystyki JPEG/PNG *(artefakty kompresji)*  
- `analysis/ast_*` (`ast_index.py`, `ast_delta.py`) â€” indeks AST, tokeny Î” (we wspÃ³Å‚pracy z `delta/tokens.py`)  
- `core/metrics/*` â€” fallback i metryki rdzenia  
- `bench/*` â€” pomiary A/B (opcjonalnie zasilajÄ… EGDB)

### 2.2 Feature Vector (przykÅ‚adowy)

KaÅ¼dy commit/PR â†’ wiersz `Î”_features` (klucze zaleÅ¼ne od repo):
```

{
"sha": "...",
"module": "analysis|core|gui|mosaic|filters|...",
"Î”LOC": 18,
"Î”Imports": +3,
"Î”CC": +2.0,
"Î”Tests": -1,
"SSIM_drop": 0.07,
"PSNR_drop": 1.9,
"Î”FanIn": +1,
"Î”FanOut": 0,
"Token:MODIFY_SIG": 1,
"Token:Î”TYPE_HINTS": 3,
...
}

```

### 2.3 Artefakty

- `.glx/metrics.parquet` â€” przyrostowy log cech (commitâ†’features)  
- `.glx/delta_report.json` â€” tokeny Î” + fingerprint + score + naruszenia I*  
- `.glx/spec_state.json` â€” snapshot Î±/Î²/Z + EWMA/MAD + stan freeze  
- **Appendix (opcjonalnie)**: `mosaic_*.png` â€” wizualizacja Î” na mozaice (jeÅ›li dotyczy)

---

## 3. Kalibracja progÃ³w (Î±/Î²/Z)

**ZaÅ‚oÅ¼enia:** progi sÄ… **reguÅ‚ami**, nie staÅ‚ymi liczbami. SÄ… liczone **per moduÅ‚** z historii Î” (okno kroczÄ…ce).

### 3.1 Estymatory

- **EWMA**: `Î¼_t = Î»Â·x_t + (1-Î»)Â·Î¼_{t-1}` (domyÅ›lnie `Î»âˆˆ[0.1,0.3]`)  
- **MAD (robust Ïƒ)**: `Ïƒ â‰ˆ 1.4826Â·MAD`  
- **Kwantyle t-digest / PÂ²**: `Î±=Q(0.90)`, `Î²=Q(0.95)`, `Z=Q(0.99)` (per cecha i/lub score)

### 3.2 Score i bramki

`score = wáµ€Â·z(Î”_features)` (standaryzowane z uÅ¼yciem EWMA/MAD).  
**Gates (CI/BUS):**
- `score â‰¤ Î±` â†’ *auto-merge okno techniczne* (jeÅ›li polityka na to pozwala),
- `Î± < score â‰¤ Î²` â†’ *wymagany review*,
- `Î² < score â‰¤ Z` â†’ *twardy block*,
- `score > Z` â†’ *NO-GO* + alert.

> Wagi `w` na starcie rÄ™czne (w `/spec/invariants.yaml`), pÃ³Åºniej **uczone** z historii (logistic/XGBoost).

---

## 4. Drift i stan â€Freezeâ€

**SygnaÅ‚ detekcji:** Page-Hinkley / ADWIN na `score`/wybranych cechach.  
**Reakcja:**  
- publikacja `spec.freeze.start` (BUS),  
- zamroÅ¼enie aktualnych progÃ³w na N commitÃ³w,  
- zbieranie etykiet (czy PR bezproblemowy),  
- `spec.freeze.end` po stabilizacji i **re-kalibracja** z nowymi priors.

HUD (Spec Monitor) pokazuje **historiÄ™ progÃ³w**, okresy freeze i â€dlaczegoâ€.

---

## 5. Integracja z AgentemAI (RAG + Healer)

**Kontekst RAG** (dla propozycji napraw/diagnoz):  
- Top-K zdarzeÅ„ EGDB (ostatnie N minut/godz.) dla `sha`/gaÅ‚Ä™zi,  
- `Î”_features` + tokeny `delta/tokens.py`,  
- mapy `Î¦(Î”_AST) â†” Î”_MOZ` (komutacja dla I3),  
- polityki z `security/sast_bridge.py` i `spec/invariants.yaml`.

**PrzepÅ‚yw (skrÃ³tem):**
1. `test.fail | build.fail | invariants.violation` â†’ BUS  
2. AgentAI pobiera **kontekst** (EGDB + Î” + spec_state)  
3. Tworzy `heal.proposal` (patch/test/config) + **dowody**  
4. `guard` sprawdza I1â€“I4 + polityki ryzyka  
5. sandbox/CI/mutation/canary â†’ `heal.verify.*`  
6. wynik â†’ `heal.applied | heal.rejected | rollback`

---

## 6. EGDB / EGQL â€” minimalny zestaw widokÃ³w

**Widoki przykÅ‚adowe (`views.sql`):**
- `vw_delta_over_time(module)` â€” trendy score/cech w oknie  
- `vw_gate_outcomes()` â€” outcome vs prÃ³g (ROC-like)  
- `vw_drifts()` â€” rejestr freeze i przyczyn

**Zapytania EGQL (przykÅ‚ady):**
```

-- ostatnie zdarzenia dla SHA, z naruszeniami I*
events.where(sha=$sha)
.join('invariants.violation')
.last(200)

```

---

## 7. HUD (Spec Monitor + Delta Inspector)

- **Spec Monitor:** Î±/Î²/Z per moduÅ‚, stan freeze, drift, â€explain why blockedâ€.  
- **Delta Inspector:** histogram tokenÃ³w, energia Î”Z, fingerprint PR, linki do linii.

---

## 8. API i kontrakty

- **BUS topics (subset):**  
  `metrics.delta.upsert`, `invariants.thresholds.update`,  
  `spec.freeze.start|end`, `invariants.violation`,  
  `heal.proposal`, `heal.verify.start|done`, `heal.applied|rollback`.

- **Schematy (`/spec/schemas`):**  
  `git.delta.ready.schema.json`, `publish.schema.json`, `fail.closed.schema.json` (dziedziczone z katalogu v5).

---

## 9. Operacja w CI/Hookach

- **pre-commit**: szybkie cechy Î” z dotkniÄ™tych plikÃ³w + mini-score,  
- **post-commit**: peÅ‚ny wektor cech â†’ `.glx/metrics.parquet` + update `spec_state.json`,  
- **PR Action**: tokeny Î” + `delta_report.json` â†’ komentarz do PR + gate wg progÃ³w.

---

## 10. Akceptacja i metryki sukcesu

- **Coverage Analytics:** â‰¥ 90% commitÃ³w ma poprawnie zapisane `Î”_features`.  
- **StabilnoÅ›Ä‡ progÃ³w:** drift â‰¤ 1/tydzieÅ„ per moduÅ‚ po 2 tyg. kalibracji.  
- **MTTR-Sec/Quality:** spadek mediany o â‰¥ 20% po wÅ‚Ä…czeniu gatingu.  
- **FP-rate (gates):** â‰¤ 10% po pierwszym miesiÄ…cu (z zamroÅ¼eniami).

---

## Appendix A â€” Mapowanie moduÅ‚Ã³w

- `analysis/metrics.py`, `diff.py`, `spectral.py`, `formats.py`, `exporters.py`  
- `delta/tokens.py`, `delta/fingerprint.py`, `delta/features.py`  
- `spec/calibrate.py`, `spec/loader.py`  
- `io/artifacts.py` (zapis `.glx/*`)  
- `security/sast_bridge.py` (wpÅ‚ywa na score/priorytety)

## Appendix B â€” PrzykÅ‚adowe artefakty

DoÅ‚Ä…czone z `analysis/last/*`: `summary.md`, `autonomy/pack.md` (przykÅ‚ady raportÃ³w).
```

---

# IV. Podsumowanie dziaÅ‚aÅ„

**Co doÅ‚Ä…czamy teraz:**

* `docs/31_analytics.md` (powyÅ¼ej â€” kompletna treÅ›Ä‡).
* Appendixy: wÅ‚Ä…czymy *wyciÄ…gi* z `GLX_Mosaika_Matematyka_v5.md`, `12_mosaic_metrics.md` do `docs/14_mosaic.md`;
  fragmenty `DIFF_SUMMARY.md` do `docs/13_delta_algebra.md`.

**Co regenerujemy w nastÄ™pnych pÄ™tlach:**

* Drobne uzupeÅ‚nienia `docs/41_pipelines.md` (Å›cieÅ¼ki wywoÅ‚aÅ„/registry).
* Dodatkowe sekcje ilustracyjne do `docs/40_gui_app.md` (zrzuty HUD i link do `gui/services/pipeline_runner.py`).

**Co do archiwum (nie publikujemy jako docs):**

* Dzienniki `analysis/logs/*.json`, snapshoty packÃ³w w `analysis/last/*` (zostajÄ… jako artefakty `.glx/backup`).

**Rename (zostawiamy stuby-redirecty):**

* `docs/80_release.md` â†’ `docs/82_release_and_channels.md`
* `docs/90_playbooks.md` â†’ `docs/92_playbooks.md`



#!/usr/bin/env bash
# glitchlab/.githooks/prepare-commit-msg
set -euo pipefail

MSGFILE="$1"
ROOT="$(git rev-parse --show-toplevel)"
SNIP="$ROOT/.glx/commit_snippet.txt"

# jeżeli snippet istnieje i nie jest pusty — spróbuj wstrzyknąć
if [[ -s "$SNIP" && -f "$MSGFILE" ]]; then
  # idempotencja: nie duplikuj, jeśli już jest znacznik generacji
  if ! grep -Fq "Generated-by: pre-diff" "$MSGFILE"; then
    TMP="${MSGFILE}.tmp.$$"
    {
      cat "$SNIP"
      echo
      cat "$MSGFILE"
    } > "$TMP"
    mv "$TMP" "$MSGFILE"
  fi
fi
